<!DOCTYPE html> <html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> <title>nginx测试异常问题定位 &mdash; Jared</title> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/vendor/primer-css/css/primer.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/components/collection.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/components/repo-card.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/sections/repo-list.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/components/boxed-group.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/globals/common.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/globals/responsive.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/css/posts/index.css"> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/vendor/octicons/octicons/octicons.css"> <link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"> <!-- Latest compiled and minified CSS --> <link rel="canonical" href="https://Jared-ZDC.github.io/2022/05/11/nginx-hashconnect/"> <link rel="alternate" type="application/atom+xml" title="Jared" href="https://Jared-ZDC.github.io/feed.xml"> <link rel="shortcut icon" href="https://Jared-ZDC.github.io/favicon.ico"> <meta property="og:title" content="nginx测试异常问题定位"> <meta name="keywords" content="nginx"> <meta name="og:keywords" content="nginx"> <meta name="description" content="总结"> <meta name="og:description" content="总结"> <meta property="og:url" content="https://Jared-ZDC.github.io/2022/05/11/nginx-hashconnect/"> <meta property="og:site_name" content="Jared"> <meta property="og:type" content="article"> <meta property="og:locale" content="zh_CN" /> <meta property="article:published_time" content="2022-05-11"> <script src="https://Jared-ZDC.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://Jared-ZDC.github.io/assets/js/jquery-ui.js"></script> <script src="https://Jared-ZDC.github.io/assets/js/main.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script> </head> <body class="" data-mz=""> <header class="site-header"> <div class="container"> <h1><a href="https://Jared-ZDC.github.io/" title="Jared"><span class="octicon octicon-mark-github"></span> Jared</a></h1> <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <nav class="site-header-nav" role="navigation"> <a href="https://Jared-ZDC.github.io/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://Jared-ZDC.github.io/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://Jared-ZDC.github.io/archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://Jared-ZDC.github.io/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://Jared-ZDC.github.io/about/" class=" site-header-nav-item" target="" title="关于">关于</a> <a href="https://Jared-ZDC.github.io/donate/" class=" site-header-nav-item" target="" title="捐助">捐助</a> </nav> </div> </header> <!-- / header --> <section class="collection-head small geopattern" data-pattern-id="nginx测试异常问题定位"> <div class="container"> <div class="columns"> <div class="column three-fourths"> <div class="collection-title"> <h1 class="collection-header">nginx测试异常问题定位</h1> <div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/05/11 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://Jared-ZDC.github.io/categories/#问题分析" title="问题分析">问题分析</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 1669 字，约 5 分钟 </span> </div> </div> </div> <div class="column one-fourth mobile-hidden"> <div class="collection-title"> <img style="height:72px;width:72px" src="https://Jared-ZDC.github.io/assets/images/qrcode.jpg" alt="FreeJared" /> </div> </div> </div> </div> </section> <!-- / .banner --> <section class="container content"> <div class="columns"> <div class="column three-fourths" > <article class="article-content markdown-body"> <h1 id="总结">总结</h1> <p>在Intel上测试nginx发现了一个比较奇怪的现象，服务端压测时候，负载总是无法压上去，反而客户端随着核数增加，负载几乎100%，并且主要集中在sys上。</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 服务端测试命令：</span>
​
taskset <span class="nt">-c</span> 0-7 /usr/local/nginx/sbin/nginx <span class="nt">-c</span> /usr/local/nginx/conf/nginx.conf
​
<span class="c"># 客户端测试命令： 使用lo网口</span>
<span class="c"># 短链接</span>
taskset <span class="nt">-c</span> 8-31 /home/nginx-test/httpress-1.1.0/bin/Release/httpress <span class="nt">-n</span> 1000000 <span class="nt">-c</span> 200 <span class="nt">-t</span> 16  http://127.0.0.1:10000/index.html
​
</code></pre></div></div> <p><img src="https://user-images.githubusercontent.com/17999499/167791253-34096537-1fca-4aa0-84a8-24888eb75c6c.png" alt="image" /></p> <h1 id="分析">分析</h1> <p>从当前跟随核数的特征以及top显示的结果上看，问题大概率出现在抢锁的问题上。通过perf采样，可以证实：</p> <p><img src="https://user-images.githubusercontent.com/17999499/167791493-36ab3ab2-ac2d-4094-98b8-3d1ca5c57415.png" alt="image" /></p> <p>__inet_check_established函数主要实现如下：</p> <p><img src="https://user-images.githubusercontent.com/17999499/167791665-4439ffd5-5dd5-4619-9983-9da8fb7431cd.png" alt="image" /></p> <p>从这个函数代码大概可以分析出这个函数的主要用途是 判断当前的socket状态是否是TCP_TIME_WAIT的状态，如果是的话，就需要通过twsk_unique获得一个端口：</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">tcp_twsk_unique</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sktw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">twp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span> <span class="o">=</span> <span class="n">inet_twsk</span><span class="p">(</span><span class="n">sktw</span><span class="p">);</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_timewait_sock</span> <span class="o">*</span><span class="n">tcptw</span> <span class="o">=</span> <span class="n">tcp_twsk</span><span class="p">(</span><span class="n">sktw</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">reuse</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">sysctl_tcp_tw_reuse</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">reuse</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Still does not detect *everything* that goes through
                 * lo, since we require a loopback src or dst address
                 * or direct binding to 'lo' interface.
                 */</span>
                <span class="n">bool</span> <span class="n">loopback</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_bound_dev_if</span> <span class="o">==</span> <span class="n">LOOPBACK_IFINDEX</span><span class="p">)</span>
                        <span class="n">loopback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)
</span>                <span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_loopback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_v6_daddr</span><span class="p">)</span> <span class="o">||</span>
                            <span class="n">ipv6_addr_v4mapped_loopback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_v6_daddr</span><span class="p">)</span> <span class="o">||</span>
                            <span class="n">ipv6_addr_loopback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_v6_rcv_saddr</span><span class="p">)</span> <span class="o">||</span>
                            <span class="n">ipv6_addr_v4mapped_loopback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_v6_rcv_saddr</span><span class="p">))</span>
                                <span class="n">loopback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif
</span></code></pre></div></div> <p>twsk_unique接口中，会根据tcp_tw_reuse配置来判断如何分配端口。 ﻿ 如果长时间找不到可以复用的端口，那么lock的时间就会变得很长，导致了锁冲突的产生。 ﻿ 但是很神奇的是，查看系统tcp_tw_reuse的配置，已经明确是打开了复用：</p> <p><img src="https://user-images.githubusercontent.com/17999499/167792108-ba975aec-06e1-4aff-9c1a-34ddbf2c44b0.png" alt="image" /></p> <h1 id="tcp_tw_reuse分析">tcp_tw_reuse分析</h1> <p>既然tcp_tw_reuse配置已经打开，那为什么从热点上看，还有大量的连接在做hash_connect呢？ ﻿ 那么是否是有可能在这样大流量下的短链接本来就需要足够的端口来使用，资源已经严重不足了？ ﻿ 查看一下端口的使用情况以及限制：</p> <p><img src="https://user-images.githubusercontent.com/17999499/167792261-6fa76d8e-e865-4b10-8148-fe7826509c7b.png" alt="image" /></p> <p>不知道什么原因，对于系统对本地端口数量进行了限制，修改这个端口限制从40000-65535 到 0-65535后，性能提升了 100% ﻿ 但是发现尽管性能提升了，但是客户端还是在大量的hash_connect抢锁， 所以似乎还有其它的问题导致了端口没有完全复用起来。 ﻿ 使用netstat | grep TIME_WAIT确定一下数量：</p> <p><img src="https://user-images.githubusercontent.com/17999499/167792381-6435f3e6-ef5c-4603-9619-c93d4ff1bd9f.png" alt="image" /></p> <p>发现基本上已经达到极限了， 主要还是由于当前的吞吐量太高 ，已经端口复用已经无法承载了。</p> <div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"> <h3>文档信息</h3> <ul> <li>本文作者：<a href="https://Jared-ZDC.github.io" target="_blank">Jared Zhu</a></li> <li>本文链接：<a href="https://Jared-ZDC.github.io/2022/05/11/nginx-hashconnect/" target="_blank">https://Jared-ZDC.github.io/2022/05/11/nginx-hashconnect/</a></li> <li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li> <li>捐助（如果对您有帮助，可以请我喝杯咖啡）</li> <img src="http://freejared.top/images/payment/wepay.png" alt="微信" width="200" height="200"> <img src="http://freejared.top/images/payment/alipay.png" alt="支付宝" width="200" height="200" > </ul> </div> </article> <div class="share"> </div> <div class="comment"> <div id="gitalk-container"></div> <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> --> <link rel="stylesheet" href="https://Jared-ZDC.github.io/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2022/05/11/nginx-hashconnect/', clientID: 'd53ba6ef3aa4cdd2039e', clientSecret: '5b51ba217cc932074b2985063f4e1db2004e95f7', repo: 'blog-comments', owner: 'Jared-ZDC', admin: ['Jared-ZDC'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script> </div> </div> <div class="column one-fourth"> <h3>Search</h3> <div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"> </div> <ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul> <script src="http://freejared.top/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'http://freejared.top/assets/search_data.json?v=1653294649', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script> <h3 class="post-directory-title mobile-hidden">Table of Contents</h3> <div id="post-directory-module" class="mobile-hidden"> <section class="post-directory"> <!-- Links that trigger the jumping --> <!-- Added by javascript below --> <dl></dl> </section> </div> <script src="https://Jared-ZDC.github.io/assets/js/jquery.toc.js"></script> </div> </div> </section> <!-- /section.content --> <footer class="container"> <div class="site-footer" role="contentinfo"> <div class="copyright left mobile-block"> © 2015 <span title="Jared Zhu">Jared Zhu</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a> </div> <ul class="site-footer-links right mobile-hidden"> <li> <a href="javascript:window.scrollTo(0,0)" >TOP</a> </li> </ul> <a href="https://github.com/Jared-ZDC/SpaceForJared" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a> <ul class="site-footer-links mobile-hidden"> <li> <a href="https://Jared-ZDC.github.io/" title="首页" target="">首页</a> </li> <li> <a href="https://Jared-ZDC.github.io/categories/" title="分类" target="">分类</a> </li> <li> <a href="https://Jared-ZDC.github.io/archives/" title="归档" target="">归档</a> </li> <li> <a href="https://Jared-ZDC.github.io/links/" title="链接" target="">链接</a> </li> <li> <a href="https://Jared-ZDC.github.io/about/" title="关于" target="">关于</a> </li> <li> <a href="https://Jared-ZDC.github.io/donate/" title="捐助" target="">捐助</a> </li> <li><a href="https://Jared-ZDC.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li> </ul> <!-- 不蒜子访问统计 --> <script async src="https://Jared-ZDC.github.io/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script> <div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2020-05-03 </span> </div> </div> </footer> <div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a> </div> <!-- / footer --> <script src="https://Jared-ZDC.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script> </body> </html>
